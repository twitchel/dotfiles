{{- if eq .chezmoi.osRelease.id "fedora" -}}
#!/bin/bash
# Fedora package installation script for {{ .chezmoi.hostname }}
# Auto-generated from packages.json
# packages.json hash: {{ include ".chezmoitemplates/packages.json" | sha256sum }}

set -euo pipefail

{{- $packages := fromJson (include ".chezmoitemplates/packages.json") }}
{{- $machineConfig := index .machines .chezmoi.hostname | default dict }}
{{- $isPersonal := index $machineConfig "isPersonal" | default false }}
{{- $isWorkstation := index $machineConfig "isWorkstation" | default false }}
{{- $installGaming := index $machineConfig "installGaming" | default false }}
{{- $installDevTools := index $machineConfig "installDevTools" | default false }}
{{- $installMultimedia := index $machineConfig "installMultimedia" | default false }}

# Build list of enabled tags based on machine configuration
ENABLED_TAGS="base"
{{- if $isWorkstation }} ENABLED_TAGS="$ENABLED_TAGS workstation"{{ end }}
{{- if $isPersonal }} ENABLED_TAGS="$ENABLED_TAGS personal"{{ end }}
{{- if $installDevTools }} ENABLED_TAGS="$ENABLED_TAGS development"{{ end }}
{{- if $installMultimedia }} ENABLED_TAGS="$ENABLED_TAGS multimedia"{{ end }}
{{- if $installGaming }} ENABLED_TAGS="$ENABLED_TAGS gaming"{{ end }}

echo "==> Installing packages for Fedora on {{ .chezmoi.hostname }}"
echo "==> Enabled tags: $ENABLED_TAGS"
echo ""

# Enable RPM Fusion repositories (needed for multimedia packages)
{{- if or $installMultimedia $installGaming }}
if ! dnf repolist | grep -q "rpmfusion-free"; then
    echo "==> Enabling RPM Fusion repositories..."
    sudo dnf install -y \
        "https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm" \
        "https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm"
fi
{{- end }}

# Update system first
echo "==> Updating system..."
sudo dnf upgrade -y --refresh

# Setup Flatpak
echo "==> Setting up Flatpak..."
if ! command -v flatpak &> /dev/null; then
    sudo dnf install -y flatpak
fi
flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

# ============================================================================
# DNF Packages
# ============================================================================
echo "==> Installing DNF packages..."

DNF_PACKAGES=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- range $tags }}
{{- if eq . "base" }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
)

{{- if $installDevTools }}
DNF_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- $isDev := false }}
{{- $isBase := false }}
{{- range $tags }}
{{- if eq . "development" }}{{ $isDev = true }}{{ end }}
{{- if eq . "base" }}{{ $isBase = true }}{{ end }}
{{- end }}
{{- if and $isDev (not $isBase) }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $isWorkstation }}
DNF_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- $isWS := false }}
{{- range $tags }}
{{- if eq . "workstation" }}{{ $isWS = true }}{{ end }}
{{- end }}
{{- if $isWS }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $isPersonal }}
DNF_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- $isPers := false }}
{{- range $tags }}
{{- if eq . "personal" }}{{ $isPers = true }}{{ end }}
{{- end }}
{{- if $isPers }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $installMultimedia }}
DNF_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- $isMM := false }}
{{- range $tags }}
{{- if eq . "multimedia" }}{{ $isMM = true }}{{ end }}
{{- end }}
{{- if $isMM }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $installGaming }}
DNF_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if $dnfPkg }}
{{- $isGame := false }}
{{- range $tags }}
{{- if eq . "gaming" }}{{ $isGame = true }}{{ end }}
{{- end }}
{{- if $isGame }}
    {{ $dnfPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

# Remove duplicates and install
if [ ${#DNF_PACKAGES[@]} -gt 0 ]; then
    # shellcheck disable=SC2207
    UNIQUE_DNF=($(echo "${DNF_PACKAGES[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
    echo "Installing: ${UNIQUE_DNF[*]}"
    sudo dnf install -y "${UNIQUE_DNF[@]}" || true
fi

# ============================================================================
# Flatpak Packages
# ============================================================================
echo "==> Installing Flatpak packages..."

FLATPAK_PACKAGES=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- range $tags }}
{{- if eq . "base" }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
)

{{- if $installDevTools }}
FLATPAK_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- $isDev := false }}
{{- range $tags }}
{{- if eq . "development" }}{{ $isDev = true }}{{ end }}
{{- end }}
{{- if $isDev }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $isWorkstation }}
FLATPAK_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- $isWS := false }}
{{- range $tags }}
{{- if eq . "workstation" }}{{ $isWS = true }}{{ end }}
{{- end }}
{{- if $isWS }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $isPersonal }}
FLATPAK_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- $isPers := false }}
{{- range $tags }}
{{- if eq . "personal" }}{{ $isPers = true }}{{ end }}
{{- end }}
{{- if $isPers }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $installMultimedia }}
FLATPAK_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- $isMM := false }}
{{- range $tags }}
{{- if eq . "multimedia" }}{{ $isMM = true }}{{ end }}
{{- end }}
{{- if $isMM }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

{{- if $installGaming }}
FLATPAK_PACKAGES+=(
{{- range $packages.packages }}
{{- $pkg := . }}
{{- $managers := index . "managers" | default dict }}
{{- $flatpakPkg := index $managers "flatpak" | default "" }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $tags := index . "tags" | default list }}
{{- if and $flatpakPkg (not $dnfPkg) }}
{{- $isGame := false }}
{{- range $tags }}
{{- if eq . "gaming" }}{{ $isGame = true }}{{ end }}
{{- end }}
{{- if $isGame }}
    {{ $flatpakPkg }}  # {{ $pkg.name }}
{{- end }}
{{- end }}
{{- end }}
)
{{- end }}

# Install Flatpak packages
if [ ${#FLATPAK_PACKAGES[@]} -gt 0 ]; then
    # shellcheck disable=SC2207
    UNIQUE_FLATPAK=($(echo "${FLATPAK_PACKAGES[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))
    for pkg in "${UNIQUE_FLATPAK[@]}"; do
        echo "Installing Flatpak: $pkg"
        flatpak install -y flathub "$pkg" || true
    done
fi

# ============================================================================
# Fallback Installations (for packages not in dnf)
# ============================================================================
echo "==> Running fallback installations..."

{{- range $packages.packages }}
{{- $fallback := index . "fallback" | default "" }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- if and $fallback (not $dnfPkg) }}
# {{ .name }}: {{ index . "description" | default "" }}
if ! command -v {{ .name }} &> /dev/null; then
    echo "Installing {{ .name }} via fallback..."
    {{ $fallback }} || true
fi
{{- end }}
{{- end }}

# ============================================================================
# Font Installation (Nerd Fonts fallback for Fedora)
# ============================================================================
echo "==> Installing fonts..."

FONT_DIR="${HOME}/.local/share/fonts"
mkdir -p "$FONT_DIR"

{{- range $packages.packages }}
{{- $tags := index . "tags" | default list }}
{{- $fallbackUrl := index . "fallback_url" | default "" }}
{{- $managers := index . "managers" | default dict }}
{{- $dnfPkg := index $managers "dnf" | default "" }}
{{- $hasFont := false }}
{{- range $tags }}
{{- if eq . "fonts" }}{{ $hasFont = true }}{{ end }}
{{- end }}
{{- if and $hasFont $fallbackUrl (not $dnfPkg) }}
# {{ .name }}
if ! fc-list | grep -qi "{{ .name }}"; then
    echo "Installing {{ .name }}..."
    curl -fLo "/tmp/{{ .name }}.zip" "{{ $fallbackUrl }}"
    unzip -o "/tmp/{{ .name }}.zip" -d "$FONT_DIR"
    rm -f "/tmp/{{ .name }}.zip"
fi
{{- end }}
{{- end }}

fc-cache -fv

# ============================================================================
# Post-Installation Tasks
# ============================================================================
echo "==> Running post-installation tasks..."

{{- if $installDevTools }}
# Docker post-install
if command -v docker &> /dev/null; then
    sudo systemctl enable --now docker || true
    sudo usermod -aG docker "$USER" || true
fi
{{- end }}

{{- if $isPersonal }}
# Syncthing post-install
if command -v syncthing &> /dev/null; then
    systemctl --user enable --now syncthing.service || true
fi
{{- end }}

echo ""
echo "==> Package installation complete for {{ .chezmoi.hostname }}!"
echo "==> You may need to log out and back in for group changes to take effect."
{{- end }}
